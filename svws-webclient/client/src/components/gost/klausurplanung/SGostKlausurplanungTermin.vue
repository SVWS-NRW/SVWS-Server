<template>
	<div :id="'gost-klausurtermin-' + termin.id" class="svws-ui-termin h-full flex flex-col group bg-white dark:bg-black rounded-lg"
		:class="{
			'border shadow-md shadow-black/5': !inTooltip,
			'border-black/10 dark:border-white/10': !inTooltip && !terminSelected,
			'-mx-2 -my-1': inTooltip,
			'border-r-2 border-r-svws border-l-transparent': inTooltip && !termin.istHaupttermin,
			'border-black/50 dark:border-white/50 ring-4 ring-black/10 dark:ring-white/10': termin.istHaupttermin && !inTooltip && terminSelected,
			'border-svws/50 dark:border-svws/50 ring-4 ring-svws/10 dark:ring-svws/10': !termin.istHaupttermin && !inTooltip && terminSelected,
			'border-l-svws border-l-2': !termin.istHaupttermin,
		}">
		<slot name="header">
			<section class="text-headline-md leading-none px-3 pt-3" :class="{'pb-2': !$slots.tableTitle}">
				<template v-if="!$slots.tableTitle">
					<slot name="title">
						<span class="leading-tight inline-flex gap-0.5" :class="{'text-base': compact || compactWithDate}">
							<span v-if="dragIcon && !compact" class="group-hover:bg-black/10 dark:group-hover:bg-white/10 -ml-1 mr-0.5 rounded">
								<span class="icon i-ri-draggable" :class="{'-mx-0.5': !compact}" />
							</span>
							<span class="line-clamp-1 break-all">{{ terminBezeichnung() }}</span>
						</span>
						<div v-if="compactWithDate && termin.datum" class="mb-1 -mt-0.5 opacity-50 text-base">{{ DateUtils.gibDatumGermanFormat(termin.datum) }}</div>
						<div v-if="compact || compactWithDate" class="svws-compact-data text-sm font-medium flex flex-wrap mt-0.5">
							<span>{{ kMan().schuelerklausurAnzahlGetByTerminid(termin.id) }} Schüler:innen<slot name="compactMaximaleDauer">, bis {{ kMan().maxKlausurdauerGetByTerminid(termin.id) }} Minuten</slot></span>
							<span v-if="quartalsauswahl && quartalsauswahl.value === 0">, {{ termin.quartal ? termin.quartal + ' . Quartal' : 'Beide Quartale' }}</span>
						</div>
					</slot>
				</template>
				<div class="flex justify-between w-full gap-1 items-center">
					<div v-if="!compact && !compactWithDate">
						<slot name="datum">
							<template v-if="termin.datum === null">
								<span class="opacity-25 inline-flex items-center gap-1">
									<span class="icon i-ri-calendar-2-line" />
									<span>...</span>
								</span>
							</template>
							<span v-else class="opacity-50">{{ DateUtils.gibDatumGermanFormat(termin.datum) }}</span>
						</slot>
					</div>
					<div v-if="$slots.actions" class="flex gap-0.5 items-center -mr-2 -my-1">
						<slot name="actions" />
					</div>
				</div>
			</section>
		</slot>
		<slot name="main" v-if="!compact">
			<section class="flex flex-col flex-grow" :class="{'mt-2': !$slots.tableTitle, 'px-3': !inTooltip}">
				<slot name="klausuren">
					<div v-if="kursklausuren().size() === 0 && (schuelerklausurtermine().size() === 0)">
						Keine Klausuren
					</div>
					<slot name="kursklausuren" v-if="kursklausuren().size()">
						<svws-ui-table :columns="cols" :disable-header="!$slots.tableTitle" :class="{'border-t border-black/25 dark:border-white/25': !$slots.tableTitle}">
							<template #header>
								<div class="svws-ui-tr" role="row">
									<div class="svws-ui-td col-span-full" role="columnheader">
										<slot name="tableTitle" />
									</div>
								</div>
							</template>
							<template #body>
								<div v-for="klausur in kursklausuren()"
									:key="klausur.id"
									:data="klausur"
									:draggable="onDrag !== undefined && draggable(klausur)"
									@dragstart="onDrag && onDrag(klausur);$event.stopPropagation()"
									@dragend="onDrag && onDrag(undefined);$event.stopPropagation()"
									class="svws-ui-tr" role="row" :title="cols.map(c => c.tooltip !== undefined ? c.tooltip : c.label).join(', ')"
									:class="[
										props.klausurCssClasses === undefined ? '' : props.klausurCssClasses(klausur, termin),
										{
											'cursor-grab active:cursor-grabbing group': onDrag !== undefined && (draggable === undefined || draggable(klausur))
										}
									]">
									<div class="svws-ui-td" role="cell">
										<span class="icon i-ri-draggable i-ri-draggable -m-0.5 -ml-3" v-if="onDrag !== undefined && (draggable === undefined || draggable(klausur))" />
									</div>
									<div class="svws-ui-td" :class="{'-ml-2': inTooltip}" role="cell">
										{{ GostHalbjahr.fromIDorException(kMan().vorgabeByKursklausur(klausur).halbjahr).jahrgang }}
									</div>
									<div class="svws-ui-td" role="cell">
										<span class="svws-ui-badge" :style="`--background-color: ${ kMan().fachBgColorByKursklausur(klausur) };`">{{ kMan().kursKurzbezeichnungByKursklausur(klausur) }}</span>
									</div>
									<div class="svws-ui-td" role="cell">{{ kMan().kursLehrerKuerzelByKursklausur(klausur) }}</div>
									<div class="svws-ui-td flex" role="cell">
										<div>
											<span v-if="kMan().schuelerklausurterminaktuellGetMengeByTerminidAndKursklausurid(termin.id, klausur.id).size() !== kMan().kursAnzahlKlausurschreiberByKursklausur(klausur)" class="font-bold">{{ kMan().schuelerklausurterminaktuellGetMengeByTerminidAndKursklausurid(termin.id, klausur.id).size() }}/</span>
											<span :class="kMan().schuelerklausurterminaktuellGetMengeByTerminidAndKursklausurid(termin.id, klausur.id).size() !== kMan().kursAnzahlKlausurschreiberByKursklausur(klausur) ? 'line-through' : ''">{{ kMan().kursAnzahlKlausurschreiberByKursklausur(klausur) }}/</span>
											<span class="">{{ kMan().kursAnzahlSchuelerGesamtByKursklausur(klausur) }}</span>
										</div>
										<SvwsUiBadge v-if="kMan().kursklausurMitExternenS(klausur)" type="highlight" size="normal">E</SvwsUiBadge>
									</div>
									<div class="svws-ui-td svws-align-right" :class="{'pr-3': inTooltip}" role="cell">{{ kMan().vorgabeByKursklausur(klausur).dauer }}</div>
									<div v-if="showKursschiene === true" class="svws-ui-td svws-align-right"><span class="opacity-50">{{ kMan().kursSchieneByKursklausur(klausur).get(0) }}</span></div>
									<div v-if="kMan().quartalGetByTerminid(termin.id) === -1" class="svws-ui-td svws-align-right" role="cell"><span class="opacity-50">{{ kMan().vorgabeByKursklausur(klausur).quartal }}.</span></div>
									<div v-if="showLastKlausurtermin === true" class="svws-ui-td svws-align-right" role="cell"><span class="opacity-50">{{ datumVorklausur(klausur) }}</span></div>
								</div>
							</template>
						</svws-ui-table>
					</slot>
					<slot name="schuelerklausuren" v-if="showSchuelerklausuren && schuelerklausurtermine().size()">
						<s-gost-klausurplanung-schuelerklausur-table :schuelerklausuren="schuelerklausurtermine()"
							:k-man="kMan"
							:on-drag="onDrag"
							:draggable="draggable"
							:patch-klausur="patchKlausur"
							:klausur-css-classes="klausurCssClasses" />
					</slot>
					<!--<div v-else-if="schuelerklausurtermine().size()">
						{{ schuelerklausurtermine().size() }} Nachschreibklausuren
					</div>-->
					<span class="flex w-full justify-between items-center gap-1 text-sm mt-auto pr-2" :class="{'pl-3': inTooltip}">
						<div class="py-3" :class="{'opacity-50': !kursklausuren().size() && (showSchuelerklausuren && !schuelerklausurtermine().size())}">
							<span class="font-bold">{{ kMan().schuelerklausurAnzahlGetByTerminid(termin.id) }} Schüler, </span>
							<span>bis {{ kMan().maxKlausurdauerGetByTerminid(termin.id) }} Min</span>
						</div>
						<slot name="loeschen" />
					</span>
				</slot>
			</section>
		</slot>
	</div>
</template>

<script setup lang="ts">

	import type { GostKursklausurManager, GostKursklausur, GostKlausurtermin, GostSchuelerklausurTermin, GostKlausurenCollectionSkrsKrs} from "@core";
	import { GostHalbjahr} from "@core";
	import type { GostKlausurplanungDragData } from "./SGostKlausurplanung";
	import type {DataTableColumn} from "@ui";
	import {computed} from "vue";
	import {DateUtils } from "@core";

	const props = withDefaults(defineProps<{
		termin: GostKlausurtermin;
		kMan: () => GostKursklausurManager;
		klausurCssClasses?: (klausur: GostKlausurplanungDragData, termin: GostKlausurtermin | undefined) => void;
		onDrag?: (data: GostKlausurplanungDragData) => void;
		draggable?: (data: GostKlausurplanungDragData) => boolean;
		//onDrop?: (zone: GostKlausurplanungDropZone) => void;
		compact?: boolean;
		compactWithDate?: boolean;
		quartalsauswahl?: {value: number};
		dragIcon?: boolean;
		terminSelected?: boolean;
		showKursschiene? : boolean;
		showLastKlausurtermin? : boolean;
		showSchuelerklausuren?: boolean;
		showKursklausurenNachschreiber?: boolean;
		showKlausurenSelbesDatum?: boolean;
		patchKlausur?: (klausur: GostKursklausur | GostSchuelerklausurTermin, patch: Partial<GostKursklausur | GostSchuelerklausurTermin>) => Promise<GostKlausurenCollectionSkrsKrs>;
		inTooltip?: boolean;
	}>(), {
		klausurCssClasses: undefined,
		onDrag: undefined,
		draggable: () => false,
		//onDrop: undefined,
		quartalsauswahl: undefined,
		showSchuelerklausuren: false,
		patchKlausur: undefined,
		showKlausurenSelbesDatum: false,
		showKursklausurenNachschreiber: false,
		inTooltip: false,
	});

	const kursklausuren = () => props.kMan().kursklausurMitNachschreibernGetMengeByTerminid(props.termin.id, props.showKursklausurenNachschreiber);
	const schuelerklausurtermine = () => props.kMan().schuelerklausurterminFolgeterminGetMengeByTerminid(props.termin.id);

	const datumVorklausur = (klausur: GostKursklausur) => {
		const vorklausur = props.kMan().kursklausurVorterminByKursklausur(klausur);
		if (vorklausur === null)
			return "-";
		const termin = props.kMan().terminOrNullByKursklausur(vorklausur);
		return termin === null || termin.datum === null ? "-" : DateUtils.gibDatumGermanFormat(termin.datum).substring(0,6);
	};

	const terminBezeichnung = () => {
		if (props.termin.bezeichnung !== null && props.termin.bezeichnung.length > 0)
			return props.termin.bezeichnung;
		if (!props.termin.istHaupttermin)
			return "Nachschreibtermin";
		if (kursklausuren().size())
			return [...props.kMan().kursklausurGetMengeByTerminid(props.termin.id)].map(k => props.kMan().kursKurzbezeichnungByKursklausur(k)).join(", ")
		return "Klausurtermin";
	}

	function calculateColumns() {
		const cols: DataTableColumn[] = [
			{ key: "dragHandle", label: " ", fixedWidth: 1 },
			{ key: "jgst", label: "Jgst.", fixedWidth: 2 },
			{ key: "kurs", label: "Kurs", span: 1.25 },
			{ key: "kuerzel", label: "Lehrkraft" },
			{ key: "schriftlich", label: "Schriftlich", span: 0.5, align: "right", minWidth: 4.5 },
			{ key: "dauer", label: "Dauer", tooltip: "Dauer in Minuten", span: 0.5, align: "right", minWidth: 3.25 },
		];

		if (props.showKursschiene === true) {
			cols.push({ key: "kursSchiene", label: "S", tooltip: "Schiene", span: 0.25, align: "right", minWidth: 1.75 })
		}

		if (props.kMan().quartalGetByTerminid(props.termin.id) === -1) {
			cols.push({ key: "quartal", label: "Q", tooltip: "Quartal", span: 0.25, align: "center", minWidth: 1.75 })
		}

		if (props.showLastKlausurtermin === true) {
			cols.push({ key: "lastDate", label: "Vordatum", tooltip: "Datum der letzten Klausur", span: 0.25, align: "center", minWidth: 4.75 })
		}

		return cols;
	}

	const cols = computed(() => calculateColumns());

</script>

<style lang="postcss" scoped>
.svws-warning {
  .i-ri-draggable {
    @apply opacity-10;
  }

  &:hover {
    .i-ri-draggable {
      @apply opacity-100 text-black dark:text-white;
    }
  }
}
</style>

<style lang="postcss">
.svws-ui-termin {
  .text-input--headless {
    @apply text-headline-md;

    &:not(:focus) {
      &::placeholder {
        @apply text-black dark:text-white;
      }
    }

    &::placeholder {
      @apply font-bold;
    }
  }

  .svws-klausurplanung-schienen-termin & {
	@apply border-0 rounded-xl;

	}

  .svws-selected & {
    .text-input--headless {
      &:not(:focus) {
        &::placeholder {
          @apply text-svws dark:text-svws;
        }
      }

      &:focus {
        &::placeholder {
          @apply text-svws/50 dark:text-svws/50;
        }
      }
    }
  }

}

.svws-ui-stundenplan--unterricht .svws-ui-termin {
  @apply z-10;

  .px-3 {
    @apply my-auto;
    padding: 0 0.25rem;
  }

  .svws-compact-data {
    @apply justify-center;
  }
}
</style>
